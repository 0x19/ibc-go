package wasm_test

import (
	"encoding/hex"
	"math"
	"os"
	"testing"
	"time"

	_go "github.com/confio/ics23/go"
	"github.com/cosmos/cosmos-sdk/codec"
	sdk "github.com/cosmos/cosmos-sdk/types"
	clienttypes "github.com/cosmos/ibc-go/v5/modules/core/02-client/types"
	commitmenttypes "github.com/cosmos/ibc-go/v5/modules/core/23-commitment/types"
	"github.com/cosmos/ibc-go/v5/modules/core/exported"
	wasm "github.com/cosmos/ibc-go/v5/modules/light-clients/10-wasm/types"
	ibctesting "github.com/cosmos/ibc-go/v5/testing"
	"github.com/cosmos/ibc-go/v5/testing/simapp"
	"github.com/stretchr/testify/suite"
	tmproto "github.com/tendermint/tendermint/proto/tendermint/types"
)

type WasmTestSuite struct {
	suite.Suite
	coordinator *ibctesting.Coordinator
	wasm        *ibctesting.Wasm // singlesig public key
	// Tendermint chain
	chainA *ibctesting.TestChain
	// Grandpa chain
	chainB         *ibctesting.TestChain
	ctx            sdk.Context
	cdc            codec.Codec
	now            time.Time
	store          sdk.KVStore
	clientState    wasm.ClientState
	consensusState wasm.ConsensusState
	codeId         []byte
}

func (suite *WasmTestSuite) SetupTest() {
	suite.coordinator = ibctesting.NewCoordinator(suite.T(), 2)
	suite.chainA = suite.coordinator.GetChain(ibctesting.GetChainID(1))
	suite.chainB = suite.coordinator.GetChain(ibctesting.GetChainID(2))

	suite.wasm = ibctesting.NewWasm(suite.T(), suite.chainA.Codec, "wasmsingle", "testing", 1)
	// suite.solomachineMulti = ibctesting.NewSolomachine(suite.T(), suite.chainA.Codec, "solomachinemulti", "testing", 4)

	// commit some blocks so that QueryProof returns valid proof (cannot return valid query if height <= 1)
	suite.coordinator.CommitNBlocks(suite.chainA, 2)
	suite.coordinator.CommitNBlocks(suite.chainB, 2)

	// TODO: deprecate usage in favor of testing package
	checkTx := false
	app := simapp.Setup(checkTx)
	suite.cdc = app.AppCodec()
	suite.now = time.Date(2020, 1, 2, 0, 0, 0, 0, time.UTC)
	suite.ctx = app.BaseApp.NewContext(checkTx, tmproto.Header{Height: 1, Time: suite.now}).WithGasMeter(sdk.NewInfiniteGasMeter())
	wasmConfig := wasm.VMConfig{
		DataDir:           "tmp",
		SupportedFeatures: []string{"storage", "iterator"},
		MemoryLimitMb:     uint32(math.Pow(2, 12)),
		PrintDebug:        true,
		CacheSizeMb:       uint32(math.Pow(2, 8)),
	}
	validationConfig := wasm.ValidationConfig{
		MaxSizeAllowed: int(math.Pow(2, 26)),
	}
	suite.store = suite.chainA.App.GetIBCKeeper().ClientKeeper.ClientStore(suite.chainA.GetContext(), exported.Wasm)
	data, err := hex.DecodeString("0a2031ec6480de493749ba9891a69d1f03705baf6eb983cf736595e013a1e1a50b0e10cd011804280230d00f384f42240a2088dc3417d5058ec4b4503e0c12ea1a0a89be200fe98922423d4334014fa6b0ee100142240a20d17c2d7823ebf260fd138f2d7e27d114c0145d968b5ff5006125f2414fadae69100142240a20439660b36c6c03afafca027b910b4fecf99801834c62a5e6006f27d978de234f100142240a205e639b43e0052c47447dac87d6fd2b6ec50bdd4d0f614e4299c665249bbd09d9100142240a201dfe3e22cc0d45c70779c1095f7489a8ef3cf52d62fbd8c2fa38c9f1723502b5100142240a20568cb4a574c6d178feb39c27dfc8b3f789e5f5423e19c71633c748b9acf086b51001")
	suite.Require().NoError(err)
	clientState := wasm.ClientState{
		Data: data,
		LatestHeight: &clienttypes.Height{
			RevisionNumber: 1,
			RevisionHeight: 2,
		},
		ProofSpecs: []*_go.ProofSpec{
			{
				LeafSpec: &_go.LeafOp{
					Hash:         _go.HashOp_SHA256,
					Length:       _go.LengthOp_FIXED32_BIG,
					PrehashValue: _go.HashOp_SHA256,
					Prefix:       []byte{0},
				},
				InnerSpec: &_go.InnerSpec{
					ChildOrder:      []int32{0, 1},
					ChildSize:       33,
					MinPrefixLength: 4,
					MaxPrefixLength: 12,
					EmptyChild:      nil,
					Hash:            _go.HashOp_SHA256,
				},
				MaxDepth: 0,
				MinDepth: 0,
			},
		},
		Repository: "test",
	}
	os.MkdirAll("tmp", 0o755)
	wasm.CreateVM(&wasmConfig, &validationConfig)
	data, err = os.ReadFile("ics10_grandpa_cw.wasm")
	suite.Require().NoError(err)

	err = wasm.PushNewWasmCode(suite.store, &clientState, data)
	suite.Require().NoError(err)
	suite.clientState = clientState
	data, err = hex.DecodeString("0a0b08e483ee9b0610c0eea219122073e5045222d49710bf59be580389245e9f7fc67c86b9263eee9578bfa0205df7")
	suite.Require().NoError(err)
	consensusState := wasm.ConsensusState{
		Data:      data,
		CodeId:    clientState.CodeId,
		Timestamp: uint64(suite.now.UnixNano()),
		Root: &commitmenttypes.MerkleRoot{
			Hash: []byte{0},
		},
	}
	suite.consensusState = consensusState
	suite.codeId = clientState.CodeId
	// err = clientState.Initialize(suite.ctx, suite.cdc, suite.store, &consensusState)
	// suite.Require().NoError(err)

	// err = clientState.VerifyClientMessage()

	/*
		path := ibctesting.NewPath(suite.chainA, suite.chainB)
		// path.EndpointA.ClientID = "unnamed_client_a"
		// path.EndpointB.ClientID = "unnamed_client_b"
		// endpointA := ibctesting.NewDefaultEndpoint(suite.chainA)
		// endpointA.ClientID = "unnamed_client_a"
		// endpointB := ibctesting.NewDefaultEndpoint(suite.chainB)
		// endpointB.ClientID = "unnamed_client_b"
		fmt.Println("A", path.EndpointA.ClientConfig.GetClientType())
		path.EndpointB.ClientConfig = ibctesting.NewWasmConfig()
		fmt.Println("B", path.EndpointB.ClientConfig.GetClientType())
		suite.Require().NoError(err)
		msg, err := clienttypes.NewMsgCreateClient(&clientState, &consensusState, path.EndpointA.Chain.SenderAccount.GetAddress().String())
		suite.Require().NoError(err)
		res, err := suite.chainA.SendMsgs(msg)
		suite.Require().NoError(err)
		path.EndpointA.ClientID, err = ibctesting.ParseClientIDFromEvents(res.GetEvents())
		suite.Require().NoError(err)

		suite.Require().NoError(err)
		msg, err = clienttypes.NewMsgCreateClient(&clientState, &consensusState, path.EndpointB.Chain.SenderAccount.GetAddress().String())
		suite.Require().NoError(err)
		res, err = suite.chainB.SendMsgs(msg)
		suite.Require().NoError(err)
		path.EndpointB.ClientID, err = ibctesting.ParseClientIDFromEvents(res.GetEvents())
		suite.Require().NoError(err)

		err = path.EndpointA.ConnOpenInit()
		suite.Require().NoError(err)

		err = path.EndpointB.ConnOpenTry()
		suite.Require().NoError(err)

		err = path.EndpointA.ConnOpenAck()
		suite.Require().NoError(err)

		err = path.EndpointB.ConnOpenConfirm()
		suite.Require().NoError(err)

		// ensure counterparty is up to date
		// err = path.EndpointA.UpdateClient()
		// suite.Require().NoError(err)

		// header := wasm.Header{
		// 	Data: []byte{0},
		// 	Height: &clienttypes.Height{
		// 		RevisionNumber: 1,
		// 		RevisionHeight: 2,
		// 	},
		// }
		// msg, err := clienttypes.NewMsgUpdateClient(
		// 	endpointA.ClientID, &header,
		// 	suite.chainA.SenderAccount.GetAddress().String(),
		// )
		// endpointA.ClientConfig = &ibctesting.WasmConfig{
		// 	InitClientState:    clientState,
		// 	InitConsensusState: consensusState,
		// }
		println(res)
	*/
}

func (suite *WasmTestSuite) TestVerifyClientMessageHeader() {
	var (
		clientMsg   exported.ClientMessage
		clientState *wasm.ClientState
	)

	// test singlesig and multisig public keys
	for _, wm := range []*ibctesting.Wasm{suite.wasm} {
		testCases := []struct {
			name    string
			setup   func()
			expPass bool
		}{
			{
				"successful header",
				func() {
					data, err := hex.DecodeString("0ab7480a207e5f2e4bdd7a05cf7733d4f31c7fe0a31b1d04f025bb7f52fba57b980742d7e912c20515000000000000007e5f2e4bdd7a05cf7733d4f31c7fe0a31b1d04f025bb7f52fba57b980742d7e9e6000000147e5f2e4bdd7a05cf7733d4f31c7fe0a31b1d04f025bb7f52fba57b980742d7e9e6000000d9d80db0182f10e72d57b5069b56b7ef0a2f73e1b78ecf75f050aa869e815b11e8ad6bc7c756bd917d2d8e90c38f9e2486d98f90ec07e71c1c1a300723017f071dfe3e22cc0d45c70779c1095f7489a8ef3cf52d62fbd8c2fa38c9f1723502b57e5f2e4bdd7a05cf7733d4f31c7fe0a31b1d04f025bb7f52fba57b980742d7e9e6000000365afb4a449bc0ce6c37a9cb3219f6cab191885cc2d9129a3220c768d9cb038436cd8f7e92e1ccac46c0cd1bd8d56e62c5c204f448682a24e4a121f3bb01620a439660b36c6c03afafca027b910b4fecf99801834c62a5e6006f27d978de234f7e5f2e4bdd7a05cf7733d4f31c7fe0a31b1d04f025bb7f52fba57b980742d7e9e6000000895a73c965d88d49e8733b4426abc357c03552c35993e22f1096b49f2d3c37b299ed86577ff99abdab04c9d7d604983faaffc81f56111183c620321fafac970e568cb4a574c6d178feb39c27dfc8b3f789e5f5423e19c71633c748b9acf086b57e5f2e4bdd7a05cf7733d4f31c7fe0a31b1d04f025bb7f52fba57b980742d7e9e6000000a5fe8f93c2299b30bc743e3a3b34cdc27aec8febbe8e293efa348bd802ffae56b36e7f82a3e9b6a040a4176007d304cfe9b87cb5f0e77b703a7fa26eeef2320d5e639b43e0052c47447dac87d6fd2b6ec50bdd4d0f614e4299c665249bbd09d97e5f2e4bdd7a05cf7733d4f31c7fe0a31b1d04f025bb7f52fba57b980742d7e9e6000000e9639299b530b34435937e184dd07f1d9ef9502c41d0155d70c13d3d4efe9579b2c90f80271b106b0a7ddc3ada6f3c72e4fb407ba17f6281afa45f12e5cc820d88dc3417d5058ec4b4503e0c12ea1a0a89be200fe98922423d4334014fa6b0ee001ac502bbd93da622bd91b368c893320314a009d34b81343d8c6ab908375aa48ab5cc033503b08237463dc6a5356265ac47a987cad0aa47a723d7b2a044fef26df5e5a5ea77d4c50acccca3bef0cfb55e472a7573b13542d8c0b10eac91de62530c4f256c6e0c0642414245b5010300000000a895941000000000dad7ad5fab3d0902299dd6a4e8342b5433ecb77d1cddc3b68ade53e29adc1d57acd7b7b9474e038c3a42fc11e2beac3b338793787fc68590c08608d5a59a970892352731a9a620026f4dec93df0648e45712539290bf9a7db73d919274f31f0e04424545468403d205b93214b552c5bbd51238a6496f300765b630bb9cd7a50ec85f861ef81ff0054241424501010cea7b42bb644c8bbaafcfaf050eb06ecfe81cf662ae4b9b2832fe704e1af20f6d481e0c6e9905fb7df9660090cb772778027f1a81205599b6af7f61f71a538d1ac50231ec6480de493749ba9891a69d1f03705baf6eb983cf736595e013a1e1a50b0e3903a750f241cbfe65d70b214b2024d80572e5a57078dd300a1920a7a942d5fa6b20fce3c3942c92012af353efe26d99b2027aadee82f9a69c60b009ea5af6e1d6e50c0642414245b5010304000000a995941000000000a865fc6582b4c6e8458e7bcf0bcbe02176fb6606382629c81cff2a6796a85b0f67e0418d2c33794df93c6802c6c263c0cc275408a8c45149b6962c1e278c81065e56e332c777513d678801e96ec3040fc10a566dda2a3d1fb882408087d4270c04424545468403c7bceae8fd01d0970a65dda0f1e9d55b7a2bf04d63d693c97336c6b697e1d3df054241424501013e6f7ccae8bbd4bd9260df49e5fdb58070454b9369da1116553de8f7932f2220963ecd67b5c716f6d08ed05afa4dc0ebbd1e6efa59bcbf5d958e504606eb4a8b1ac502757dc74fedf688ef4d3a0bb34e578602225f3d0b5f91b9ef10177d5daa4df0a53d03f21a481c32eaeea3b9fa0943446f86ea5c40d300bb6c9ebed6b9003ec1f166943b5a657a8b8d3aeb5bee90a9cbfa0691b7475b3b8a90987e8c2a594d2e32dcb00c0642414245b5010300000000aa95941000000000f0578ee72772cd34dc23556d7cc41f9efc090ae233dd2883c4214f42b78617654ced6dac2048e9ec8098def527bcf89fd5f2f4a38bc5fae53a8a099159aff00bb24dce2d2fb4d6fb2f9b5c728a695f902d06123398c3e86f84d6114345dc7e0b04424545468403a837032db35c8f72bb54d1b2e2022401bcfa1d0d58677877b137ca8f385e1f84054241424501015a3d9960ec670c909453148221593e1c1ad4691fda9611b046ad3d71109167629c6a9960ea7cc514590d01caf9a55596952b955628c14b1c9cb1ce665905df871ac50214684326d04740d2d24425052958842a128717de5230b42bbcaeca641d9b2d2141038891380f1dc1416f859d2da5f556675c5851df37e026f9dbad452bf2e1ffecdc5a52a60455dcc5f2639a7c18be1fcbb69d6135ab19af46a048b028794fd4821d0c0642414245b5010302000000ab95941000000000a0c0c6bd29362ef18e9b404ba54ce489ecb62129e634f73fa75f4c63d720575241d27f0050cae8f890fcc90ca3f3014037dd37e57f32add9628a992f6a45b006b5cd3cb1098f9f62d65d00f8e807a5783bffabb99c74fde15f241f768d4482000442454546840300c0c1c97dac396de27aeb935c02e054895795600e25ba84447de0e2457dd62e05424142450101e200b2f65462a33c43b6ba233f6ccbbcd9f9b743efb3978b251b9152c423ff30069a4682620f14b9bbf926e7b43fdc98faa9ad8c1b4220c39ea980f49bd5f5861ac50286edc0b661a977660a3f69871588454444c13ce01503d859466576ab745f3e4645037dfc72346609e34b38dd4edf2bdefb9ee81c5b1abd6b2e74aaa274f96d1b61467c73728da64755abda2762f2e705d316b3a67f29d65bb2061df77dfbeb1afa940c0642414245b5010303000000ac95941000000000a433588b724dcfaa96b73e7dd687c415a650364dae6a48468f3f1c7439a659583a545d2824e6814b4f0b2b35fd35ebebfd7cd8af543d2b5aa893d35a2845a80a20b5328a2b833fc1024751cc2fc85e400f01fd12f1c4880087a9223240f33f0d044245454684039170f500b4cc636fabe71ada3674c65015753f89eacd38d9f84ed0ec0ddbbbc905424142450101ee5d95a7e06cc5fe408d0a4f0e525b1ff1dc562c06046e1dc63907922d93933cf8fbf1e02adac2be96d713fba4a3b01ce701bf0f4537441c1539675e68611a821ac5028811fca32bec1dad01fdbe3c0fac9c6f89d8b55df896bbcc8c55ba67c23ceb34490367222f1f83a0348ae4f8396ecc444eae73c782e62578bc6dd69220d5685160bee8cd80e5b62d10266c57199da8c5b056b10c1465d529af58d60062fd4739d5ae0c0642414245b5010302000000ad959410000000007c664f1746d335a738a6a0ef4834de32a6b5d519a2231ac9c33e7f9247c75a133eee401719e3a083bbf109d4b566a83443b3f9c74ae94f77b3350b84ee01cd0001750d86a59d12d6a0cf1f5820a029b3e3f55adda734bb48245f5611d991cb07044245454684034a7f3e573a2cefd8f84c6c8006d8d7428f069a0a4766feccb629a1be115f1e76054241424501011ea24ba0d168d4727de8fc0d1066a0f754259d1d870d7a3cadcd1934460e4d67b9ffdd2163c93dfd7ecddefa5914178fa54e46c32c572aeedc4eea7c5095e38f1ac502132eef79fee9afce523cf1fd87148c4efd75b8d703186aa0600d609aa1187b374d03f9cb53424c81abf98fb95d738acb4abee7ce38f7a7ef167470cc13d369e26a0f7f32fce5a84419b275396f56120f186be3d296aa106199063b401103a5117e2f0c0642414245b5010301000000ae95941000000000e2c5d61e5ac04f79dad33f692d3f7db93f06b968d48e0bdf720a91d2d4bc6e54a2c55512c0183e00262626868c3784fede18ac3023854afc33f2ec5c3750410b78a8028edf414345fbff7eae52b81fc6f0878ea498f78c5750363db4319faa0a044245454684031cb6269d4f012c55cdeda899fab4e4c2233b5914f1c1b45275dd091022a2dd600542414245010122870e63d7057da1629c14beddc43700350c856a7e2c95f9a381b404c9e87337a1c392ef6c4c251f363418c2ff51bece58a2c648466ad5ee3a6850f7a2989f821ac50219004d2e64bfc275501a6f2e30b7d3deec04ad511bf115818a23958c176a4a925103a07bc5de3e0fe567c6d70ec3b4964233c4e281955acef144fa8bab3c36ce0444a890941784379a9fef540d461607070658918cf1f8f6a38bd68078d714540d1d0c0642414245b5010304000000af959410000000009a0ad00569b7e8488e893ebcba5dca38e5f484a21ba99be31633502047e3077f9a947cdb343ba6d6758e6c4a344eac0a575dc3fc3f737fed615623d397204804211f1a4c4d1bdff0c0bc92e70a833e6eb01456cda3b8c8e328497df52a41f40304424545468403a6255a719b8a11426e16405b04d69708f11e334ff9a1113ed5bb65c0503b8627054241424501015a22cbad262725538eef9c53a6067d965289c5fc45abda3f26555eab6cf972462f30f7d64177a4dfa04f970404844940708d73bbce9baf69d099ac471a0d448c1ac5024a13d0c5f35199534d3dfa511d3a1e7cb169dad9da6a73b8fea5afee1d37d7415503e97519bb3171603f67caf6981f6cf820d70af46758b7d666da519fabb66b65f71b0410ad43335a7bbbc90f7774ffe8a7f48e2e908a195f371e17f6a9c49804d10c0642414245b5010104000000b09594100000000076eeecc1650c213d8312285993aab77779b874ef8dd74b93a0f6b7bb21a41348a00474651d4f902d92ff41f7b560c03cc4838246d088c2e6e0df3e6f7005370c4feccb1b80bd414094bb71cd6e64216cf3e948cd02c04ae7aaac071d72929f0d04424545468403ccc3f8bb980833b7eb30185f4079d2d479a54e824916d47db9e916e53072d41a0542414245010154d9ba796ba0acfddbe47f7202778093db52457f4f4bcd6e68d8c36070a92772515576c8ea4301b42c6dae52450159cb34fd86b9d98dd16d09c5f3a41ff59a861ac502583f23c446cd25ec829200381ee2c2ce6fd9374bdf790451e0cadb92fee71ea95903ac0c58467e609ce1cd2ac4c0bf4a807582696da7cabbed0a879fa8a8aa064cfcc9add5df661f5e6ce43dc3ca0573a8613926d4ff5b8ce0130b8fa6ecec5488f40c0642414245b5010104000000b19594100000000012f573336edde0be7f1f9d515e0c1b42e5ffec98872b46ca118588ebd4d0af40b1bde44a62c0e47f07143ac4905b021629eb03f346551d9a9f59d8cdbe0d6f01e574d8fd0909bad2f864b33bf8f4c6f784ead49368a07f7671b5e13f6a8e160104424545468403e2870c11251c7ab3b86b5b30a77d24b1a2c1f389a2f71343d20eda40797c4b480542414245010180000a217523ed213095fcf0acc96a614bbaf568f052d6e9439918ace4420242534ff9f1ee7d7e643b3ebefb0e2c4742233e8eea08b4c8ee99a9489fe16b25801ac50298e912a274975f41e85b2659823763a47255da839161ed60b603792a8fc191f05d03e1cc080fd21d447053a2d97c3b3b1d763dd900c93d6546b57fef0b4223aa09df6e87ada9721ab8a8347725e64a6b0bf537cfc4dad9c0e93d5f4552982f660a9a0c0642414245b5010303000000b295941000000000c8c919d8ead4a982e9139035d30312f24e6ff2e0ecb02816d1e5cb1624df24281bdea1b7939af2682772fef27e1ba7a473313163e43e8f11de593075e83a180737cf311ef501ed95e627543debbc18ad93d4e81a7cf553b210baa2b5cac7e10c044245454684034cd6b239bbdfcffe2b7101684c55bf16be38f8bdca50af0ecf7ec7113ba3af710542414245010112fcfb2d1771afea0ef92c1f6f3b1306b2bc2b0c44e4cfb48aaef260a543886e0a53c56f4d068616624d81fe6e259d03cb7676415bcb06ad62eff0db3d3d158f1ac502050f7c17f28dcbe03ec1fb4f9cff83565e7419304750cd718b0cc6ee7e933b8e6103680e9463eeccde6fa77feab3a0519f618b81b43558e6d86ec34319e7d49c7dd48273da9c322a4e849b0d9695f8220e78767e764b7e2f6abc425ae77dd6fe80400c0642414245b5010105000000b395941000000000549f73e11b949fd8eb46fd1f792e6d9b32a11e83683511c6cf6dcfe9b64c1d12671ecb9706e7487caac0423f0a59e1d46af1dc6481b3d21aac07a2a892e7470b65358da578c29faa40fd73993744595b7f06078171144fc2157008ec60ed740904424545468403c887d734bb8242251e0578d4e028c9b4aa14c295a44b5229ef539cbd25bbcdac0542414245010170813d3af24289f55e72252d4a239fe8bac1ada6fbd48a21c8d52e3984ff9a79c06027ad1fc1c0b05cd67d694b1d4be2d3848e5acc77f57710f3a26ae5a754831ac5022ff3371654b35b18bcd7f74a35afb90e6b940dd386b062a476d95a52a421e2b36503d8d40be995497964aa926c7f026eb40abb4e9923afb2fe80a129b6fc208abf2041d22d827bd209433698cfc344054c5886613e2e1e18f58400bcdeb9e96c6a180c0642414245b5010300000000b4959410000000005eb14e740dfb59c8c500be7362f3a0d085b74bc29f99fc0f398513dc89a19d5c71d34e3ce4a4199974f7d4ebd47694d57d75c9a826978a8eb92e056685ea170b699652b6c66768a1988cb70652e9593c132445d57f627069282aa790a9dfac0504424545468403751dc004b5ce560dc29748ab37a5f2d961dcab72b6c2cbde387183726314438205424142450101380866e51370911809e2cbde0ee22c956e73d258166c07c94f904cf00f3a510992c826744881e0355261dab4fe07476f2057eaaa601b7e846bde0bfd59ad5e8d1ac502e9d31bf15fc5c41006eddf53d2062e8311cd35bfc6b6c4681ee22931e27f96e5690362535e13ddcb04eca12acfadbd796833eead2e778e0be48f3f75963e74f81a388d90ebb1ce18ed201df3be924ddadb55e81b489149e3ac8c051d22ada620ef130c0642414245b5010303000000b5959410000000008839c45b41e7dea70e3c353a803dcd72b1efe5ee5b720b75d5445973f28e177c683f4e7b7d484f5c09a16fe3e1027f9bd8bef51d5ba9fefa560b068a6979cf0815f4a879c550573718713a86e414738cdde67c851ce3e5bf560f15c81057b30e044245454684031a61445ae9dfd95a4df7603187db400f633b63644b141f84e2f2ef2aacfbb77f054241424501010a4056b0176f038ff19562b841313fc6eb015ec4a3fe26ad3fb18e3f3f25db220b0837e03a648e3a5ae1823c9246c5bf7cdc6da834e163bd5cd74e28f6cada891ac50218d00ab5bbcc578537f16efecb309aafcd878823f32269be2c0022d738e278b16d036a1078bfa0dfbc251a0772e4422380e061be433565fc7a3cd482e0b43665be3f26c411f61b8265bb643a98e1ec338edf0b9571f6d842f391fa8fe50975762f0d0c0642414245b5010102000000b6959410000000002e82043761590c489b1b3e1dc018ff77bf84b0f59d560fc40c02f8c9388c96575735468d009b6ae5e99b33520bae31aea0f2ecd5e39c8998936a0d7b833e3c0029a6316e2a3e14887d06114f171a81b2914308f0a7d05064b17d8e06feb2b60b04424545468403de29f6b7a4307345f34f89a95525e79d2a9d8638982992c8ff39eb12dc8cf7d3054241424501016edd987d45f622e2fca4d1784e9748109c4031f67351bcfd1e31516ef66338130486d804e8a1173449b23b1a6fdf5c7d2df9e7e5826946d1ecda2dfd7356528d1ac5023136f2c50ccf91f000b25e6f8f83949405ed629c3492ae4c77db885c6170b15a71032d4e4b7a168d6e3b70c31800a4fcd799b83d173708c5461cd5ed1e3cacaafb6d01a94a034636db79c3cb96eb5e8c7053bcf1f1226c97574e3c284d6b1d251fc40c0642414245b5010302000000b7959410000000007efb6d19da63ed10dc7b2bdb86f12fb6ffd115d20b9c0f534da8daa1ec70d27cd1cfc09eb8d869c1a0c99725b76707131d49e3d126ea4597c392044da8816106cad2390112b3a9b234b6e32ef2689312992f47d10253178386d37b395810670d04424545468403c1cb6083f348de6e430f3acbd0f21aa1c1f1cb9863e41635eec5c27889cafaee05424142450101320b695e1225d912db5bf8136888b62d3da6e5851e33adb67a6ce8986877d7172551f1d9d525121239175b36f68f031420d1969a00b69e3cf9de56aea115dd811ac5026ad861e5737d63df5b49007561b0961dcb8f663de1933d7674810e42ffa7ac7e750315008bd149c0babd36ab38d4e8e57abbd4201e2ae27f7cac91be69db0952ffa67e56c5c73784160d1b4cbcf6c721803ba17519252000f57c40b940b31737e6a90c0642414245b5010104000000b895941000000000a284b9fad9bb91634d71fa8a95c0d14c9b87a67551b3231650342e441e0f60214055211e4795d0be475b89107c425044951cda848e342290185b7a09e26d860bc16aeaa3bfb77024bd544e3eb37812de4f04874d0d9cd6b3b3bceb9577a0000f044245454684037015e798f4c6b881b14aa32f337ca30bdc65ad9243479176ead7662cc4299c4105424142450101c479629edf6acb0c736632a5ede2c048409b45e8a6d24e2ae357c01b10d7726b2d80df95550c9e23faf3e4df50ac67e1bd7336276467651f22f412cde31923851ac5022c365e8eacff36589cd0ef8f17d29e8a81ad8993728d73cd763e902e51061b4379030c2b75e65ce6f51497780fd9981c40d0bd2b2fa6a38987130c2a85826c44a3e6e72fad3e35605461d9ed0903ee55e35feb172a32bc7437869a600842b92d81620c0642414245b5010302000000b9959410000000006e9c6b34a784397869d79d7b4b6fe976c5fdb5e88d8a54f9e835a888d103dc0476d726f382dab785e2729e529a8b699f7ad8a34d72c509e4178fa5f9b59dea010a93386cb44348f3c3e34630774f24b6b15a9a6d647a98b7b329db836e3b6d00044245454684039b681013ce42c3ede64e95e5f0fc5185c0b0f7694337e3a06ff25e255dc219cd05424142450101460064e1970c2b7fdb653d79847fb920dab9cc0a91af882bbf6eecaa87d7e53b9122289be14ebdaa6138f4a519e2d195ea5a6b53dbbfc37b84e96951bdd4ab851ac50267272d63273a7b928493b587ec5d6eceef72c0f9ea4c1133355701adcb0e56917d037428c02c8e0ad2fbc83551e5edc29928783d0d0485837061bb884a27b0fdec29125e0f113a7f44a43b338f5205510adb177ee938ead76105b12b966ada8c3bfe0c0642414245b5010300000000ba9594100000000030de93b675f65e2f74e0cf163602d118798acf6b983772bcbad267558851f53195419b29c59d2cb09f7916bdbc2731c5d02e6d9982935932c527a98a30807c02b4b2a92ad98c90d23a45f5917bb0c5151ee3c29811c82ff898c7fdb04456ed08044245454684035d85246d4d2d2b78774b27e50c8f9d43507477e5687b4fafd741fd99baadfdb205424142450101a870433d630ffcfbdb41cc77b8b481ca95fdac936ef8464ce5ead5c8c6ab8e351b8583d90651306d90f36202668b63b54d6aef6880f46ae97e641275545f9e871ac502e6d0cfafc1f6ee16e76e266f8be5e8376e90046feb32814665b2f129a2537ede8103e83e5247f03b0c8c3c5b306a3a341b0ac5cf095d0612691abfe431957233725d065e68b9ee23141f9801612cb986112801857849b66ce909d329ab987f50d7d10c0642414245b5010303000000bb959410000000003e9c7fb043d016fb39895594a74bc0f219ee9db9bf0ad875e43f408524feac3ad64136f18e945d657736c93f81a78343ef15d2b5e07e144a394299cc802c7d0e48b3d134407769d2d84a74978e284a1a5dddeab3efa82b2e0b85ec9eb6601c0304424545468403e94fdb0635e15ebf9610d4b43da179ac9be735dfe944ead2e2d43aae3cc4a02905424142450101cee817cb48a8dd285a3fe88ce3d01151194fc853f4f346587fc08023a176f4738c118f074c8680b705ec795e94783ef1a858e9f5ecd48ec50f90e99e7536318a1ac5026e63ecda115b5db38e3883198b88d2d83665b7149f66f0697024dd0de50331148503c65af05830d4de9427a1ee4a5336907904b112e3f9fccd365de79cd0e801d996e82068ae5ec48edf645b8821129ab4025dc153aed28bba0a979d522341ebec000c0642414245b5010103000000bc959410000000005002430aa7c5c77e2c051608c9b9cd05f4601c65d76433b929ab06d8b373d657166a3b553c71178c064f55e1240a7a9e682f8e32c8441a78cb1823af98ae5109eda6e590815b32466de3911414709140f3ae3eddffb08c7199015142f2e4200b04424545468403c5f5752f002ad903cc0a9a6c19d7e867a364bde4fa6754a2cd5bbc4b9c8cafca05424142450101540464f2cea7e851fa4bc2042c36135bf50a8d443cbf11bc8743e9f4e168dd56257afee3c4140ac9cabf165d138c9af074911acc2bfe0e6ec7c55f6c415841801ac502f75efcb288fb0209d5550d525f5357444d4838cb50e3e864d27857b899b8c51a8903c81227f3b7f35383dcbfbbec610c2ff64654b110e768f58002993ef00ded5e32a45db887e33475f5bd299d9029c62f2639aeab5f0f85292d98d83432be1f3ff30c0642414245b5010300000000bd959410000000008e14bec4c0fa44628453219fb9601d920c3c9ab5401716f6c3c9668824815a5b4c0320af8044c1515fbac57692f7a5551cda5a03f232d73532af4e88eec6540fcdbd89be1d392214708107a6ffbd4873bbe58bdae39597d179ec1d5f9578300404424545468403dd1749b8a9e24e3bee7d006e5db8caf9cfc9233f9ab868b31623be3262919ca805424142450101ee1603e372cdf3fca65e0a4b583301c66a032e08201b334fc07f83a51620b63838850892de6bb507fce71f253c80b5d2fe2d6987832500ac7e60663184e8dc841ac502e50aa770ea3dd4fea4505e61159316bfac0da906bf0313947e5a5e7c0735113a8d0310fe9367dba00afce77a2a05e89d9d794508ed229c6318c22e161969313f18b5cbd561226122127ab866b1274f74710c86f323686a0be9ae469b3e987ffc0a1d0c0642414245b5010304000000be95941000000000e88de799e617db06bd56bb244e95184322706148f58c70ffad945ad21676ff3de0f1275dd995b67e2abd691fb98381eb579dd923dc82930bba5a7f5ee778640fcfbc21be0aad87cbc7f7a40432f4e448eccb84b10271c7ef2a9c3af348b9d003044245454684034ec78218aa97b81949d8f04eb22c7e952817edf987754daf5b4d7225808c869b054241424501015c43f7fb1b476eea7395bda783f09e1bfe7cc08fe2af14b24553de1ed2b916480cd5034bbcffa170c602b748ce65f92793f44b48de7458fa2cb606acb336db851ac5029d668b1e17f323d30bb64a28bb43f7da28eb54c611d0186bcc234ef3773e7b659103046334a08097446e0b7a8b556efc62d6b8c60c7ae1887fc9609b127a3eaaffcdf86dd4b30364fe41a77b533a20c8cc7c1bda6fdf0afefc0c5b0f485356a653490c0642414245b5010304000000bf9594100000000054d8c6bff4e229f4e5007d141bd6773d2a73e13ab682a67bdde3578a0e973535d4eab4891ebf18c27b11d9f7741bec1840877df975bf720a7b8ca65ac8796a076f6b100312a8c6643ed7a59c26edacdadc4731a5a81c7cc6453ef503e9ce710e0442454546840399be43e7d21617d33e7015650a882c915fe77c5640f6b01c284a3b7af33ddfb2054241424501013a6e5dcc1c1066fe87ebe33f16b141728c5ba53dd177e9e811384d9c9927cd569c9931af707526662c3474115f317b859501f8018bbeed8646591ddde3dfa48b1ac5023022ad98204235fb969dc2365d454c47e793e33325be2eb47f61a5cc08e42d95950336c0cdf551c8a6b784d503e39e321752f501c1e5a3f1a19494be814656dd671236ee4ceef3990d4e00211e3798b439f8204b8152c95f0759988871aa2c8197fb0c0642414245b5010101000000c0959410000000009cdeb90a4fd1d831c99b616631d35943cd37f61b5cd2322628ee1864165f576f4398632265f16330b586f9df903f22d2f289e1adac5cda576ca69cfc5ec25e0c9a8873901bb73a1b22a8f6ad0b4c6412cca63e10bf9d0771a7587b8f9900710304424545468403ae2bf833ad0eba316fb766247b69b0330df117fed440ca659bf63f0de7db8bd105424142450101d848ef4f3969fcc15bd237501c5a2386df27326fcba97dccbb9b39276478c67f1ce046027d1a87a9b41544d9b7b68242df163da2ffd5da550a0a166db95feb8c1ac50247d9f076977b2a7f3cd9740c6a5b2fee58814ccc080785160c44c2117724c1a99903b3c78dd6df3e20e17ae68fd6b2200b389032db4684a814efec4ef7cfab6b49c9ff0f52b2ea5def06499cf763c88d99a0f271f0d7a47250d43509f45b7649502f0c0642414245b5010300000000c19594100000000024f5dd7d44ab028f8c9bbca49b1c78d3b45f1b99e371841e9af9d55803b5c0644cbfae028749d2226e67d3d967cc00819bf541647af90a105d234c3d206bea0d9e86ce9445fe09f87bcdb713bec658d77b3d9ef0dde68fb59a98d03d8d1ae90d04424545468403dddae55d9d23832e66a5fde24290b616e391a323dd947d8792b4926500c930ab054241424501016c762968be68bca4850210fa9eb0e4714ff969f1f95e0a18c75b648fd1b03765bedc2828ead4518ef4c1d4cf0a3e73c6b48608faf445a16b38869cde4ce7f48012960a0a20e50aa770ea3dd4fea4505e61159316bfac0da906bf0313947e5a5e7c0735113a12f1090ac9015703f5a4efb16ffa83d0070000e902e102ca4696a7a4883417c5756e4451d69c17e490e9169a1d780843607cf8555cf21a65013653d41b4d0f880bc01d1f068d2e058ac721f212517580935d4ca45fa5d12171de2475bd522a825dba3574ca579fc9dff4adc4b8229cf090b5ac6b654e55061208066175726120dd4a4a080000000005617572610101247fb87d9903693ac6169524702e6bf055364e6b638dd317f6f4a40bf862e253ed7b3c82b10aac6e0bc0b4bcb18c665d450e55d804085eeeedf61e36e3e04c8e0a870180046480fbbb885d15b1f823aa08eb523849b9b4b5f13ca6d1980b5a916d772abf60b1f780f6f6801e4b41e2e6d8ec194dba122bfb9eb33feb2545ef5144cea79551f7cc52801ed730a9f776b21e2d35b075a2961fae0cd4a5e16117a3395a43e3c002d24f5a80c71003b910e2885a0e54c27797fb328648309fb6e911d0542248b9b268905eee0ad10380ffbe80e1b2c503172880c484237b1ac7845b87e580b592aab0df0b8a31285974fcdec080910eb50303046d4eb463fd59f1a51f46bef7403785144e740a1c09f38c30b15f80216166048ecf8c0923524799adf3ef6bb2e8efffa9821c964f869068c416e50a80f3a72baa4d74ceb1f1e6a716dacc1d55c60ce0083d4514736a947595545cd1c58092b04d5a90ab82d79c47f2a48bf61a653375a203bfa89d1c74b68104ee8da13c808e0316eb97639069a44d82bc98afc5d69232171199756e4d3bd09f117c2b12f080c32df50ce42e9b0820db1b37a36ddaf9c17838c3115148667bdaff5afbc23ffa80b1f4de7c3ac5665016d561a60659cd2d8f2d3e0a97e2ea9749279bd8e35eb1f180628efad4380994f5cc19eed332e7e1a7ae1c0793ee936d56f413de60998cfc8680f60cbfa9c095ed37602eba939951464345be38e75d36373ab63c53bc072122f280a59be6787cea86a99451130547d8643e13eb18dfa760eed79920adfca38509c68011b8f098a8e00b577a1e6e9fe0ddd47d45ee0a5779ae9ba6f093062444338e15805182d986704de7c665bc8478a1f802c8228d997f7a242cec7761b6460b4b29c480cb3819adf226e52efd760aa984a838928784f335031c633692293afdd23b1a4a0a95029e710b30bd2eab0352ddcc26417aa1945f43803b3441f15daa8a53147d69c48eac75356fab581febbb8030520b248c5942a14880c5fa37635500764b022a030d09e1c4f94a01f88f9a3820535c0045059d26f7cf802e2e0716043a02f2f29fdd52922704af194b98545ce5ca832255e8ec41bcdb6480d3771890d37ee34ff5b8471df134cfbc10ecf58d129e6ed4900daf1ad00455c1505f0e7b9012096b41c4eb3aaf947f6ea4290800004c5f03c716fb8fff3de61a883bb76adb34a2040080eab29f0aa54f8779bb6cb455a1837c56ba0f26e82961b2356540bb7749d58e034c5f0f4993f016e2d2f8e5f43be7bb259486040080c817f35ab3d088bbbd3ef0917d6baf3efa9b40ef28b14b6f1a420ceff86489510a559f0b3c252fcb29d88eff4f3de5de4476c3500080a6536ae6f4c6d948c33cc1a94ecc62abc3664ca186f4b687dc3c906e4bdf3d368076d51ee08c67fb5d212478f7faa20257a7a1df09cbe8df9c750a5400c53b21ef120b280401000b034f759a84011a4981001101084000806b93f766a794abaff6baad4ca60fee2b73fc19b062eb12190975ec8822d9b76780ffb85bae4a23cf5fb86dbc63aaaf274b1da503657ee627a77ba33ecb04e370b612960a0a20e9d31bf15fc5c41006eddf53d2062e8311cd35bfc6b6c4681ee22931e27f96e512f1090ac9015703f5a4efb16ffa83d0070000e902e1028c3a791d532b2a687e542057169bd470b3daea1a18edb6576835970d5b3fe80c5501bc427238a8d5fdad3b9b1e81e595d390357aee588dfda929ec6609fd61d86673e8dde5de512232c8999f2f4a6a2c96d7f4273f599f843d73492a9a91a1c89f2d08066175726120d94a4a0800000000056175726101010e793440d97e2da958fcbe94233fada839f02c5fbc3a6da529331154e2b4282c3512664bb9273d443d0a0646c62cbc89f66dc71b1b64f5b7207d0fa45fd65e8a0a870180046480fbbb885d15b1f823aa08eb523849b9b4b5f13ca6d1980b5a916d772abf60b1f780f6f6801e4b41e2e6d8ec194dba122bfb9eb33feb2545ef5144cea79551f7cc5280ee5228e2953bea826838f890f9bd9c5d02d923e05bd170272781d02e6f13c94780c71003b910e2885a0e54c27797fb328648309fb6e911d0542248b9b268905eee0ad10380ffbe80e1b2c503172880c484237b1ac7845b87e580b592aab0df0b8a31285974fcdec0805ed393b1f5f92f25f984bdbc7259f477577771e73274cbaa6f3a9648e370b83280f8b02ae3ecc7a738f7de3e2954a51ba61383baa21ee7b3821374c1a8172218288065bc421b3bb349d055b528c375542cf4252262ae6494cb5e646ae2542b9f212e80c4c845e485989d62f4fcd2e4a701d95541e5aad09e33e7d823eb55409b2d11588059bc0d1ecf011f37cc149cfce145565d961b12f982649a0196ba2f3d132fa54d80bf4e516f82c92121798a1e0eb8f750d6347be2be0d85ab44a580f17ec9c36c5580b1f4de7c3ac5665016d561a60659cd2d8f2d3e0a97e2ea9749279bd8e35eb1f1802991eec38c5c93096747aa7dcdc6bedbffebfd87605f8e3ee5111415f1906cec80d195a68a9d7a18e52a3185fd0fd93749341ce20b0cc7593b888c934c853780f880a59be6787cea86a99451130547d8643e13eb18dfa760eed79920adfca38509c68075e58f8f93dbc7529478838a9e64985f1611d532885922f54784c27661e9d2f2805182d986704de7c665bc8478a1f802c8228d997f7a242cec7761b6460b4b29c4807b0ba2416ee09f0081a504c119f29f5c9a48f05183e9a9d511f184c0da7662f10a95029e710b30bd2eab0352ddcc26417aa1945f43803b3441f15daa8a53147d69c48eac75356fab581febbb8030520b248c5942a148802c263358806d768aa463f438fa36ebc3fd1b0017aaa9dd14f1849d992e98808a802e2e0716043a02f2f29fdd52922704af194b98545ce5ca832255e8ec41bcdb6480d3771890d37ee34ff5b8471df134cfbc10ecf58d129e6ed4900daf1ad00455c1505f0e7b9012096b41c4eb3aaf947f6ea4290800004c5f03c716fb8fff3de61a883bb76adb34a2040080eab29f0aa54f8779bb6cb455a1837c56ba0f26e82961b2356540bb7749d58e034c5f0f4993f016e2d2f8e5f43be7bb259486040080c817f35ab3d088bbbd3ef0917d6baf3efa9b40ef28b14b6f1a420ceff86489510a559f0b3c252fcb29d88eff4f3de5de4476c35000804ac5169dff59eb6cc64e4b0e77eca4a90640ab979c178d8a3ef3233171c5a860801fdec9e7d0b0cf4927863742cd8c628c1e58dbdd2f489fa2d55942f396f0a1a5120b280401000b0f7c749a84011a4981001101084000807201767055341267e61bb800c69bcb03afc5d85776a4abc401a2d5f2d37731e9807cdb20ef29c7ad05aeac21c68ec2a3a5f5754fe2832fc84d2f0bca0c4eee00fb")
					suite.Require().NoError(err)
					clientMsg = &wasm.Header{
						Data: data,
						Height: &clienttypes.Height{
							RevisionNumber: 1,
							RevisionHeight: 2,
						},
					}
					println(wm.ClientID)
					// clientMsg = wm.CreateHeader(wm.Diversifier)
				},
				true,
			},
			/*
				{
					"successful header with new diversifier",
					func() {
						clientMsg = sm.CreateHeader(sm.Diversifier + "0")
					},
					true,
				},
				{
					"successful misbehaviour",
					func() {
						clientMsg = sm.CreateMisbehaviour()
					},
					true,
				},
				{
					"invalid client message type",
					func() {
						clientMsg = &ibctm.Header{}
					},
					false,
				},
				{
					"wrong sequence in header",
					func() {
						// store in temp before assigning to interface type
						h := sm.CreateHeader(sm.Diversifier)
						h.Sequence++
						clientMsg = h
					},
					false,
				},
				{
					"invalid header Signature",
					func() {
						h := sm.CreateHeader(sm.Diversifier)
						h.Signature = suite.GetInvalidProof()
						clientMsg = h
					}, false,
				},
				{
					"invalid timestamp in header",
					func() {
						h := sm.CreateHeader(sm.Diversifier)
						h.Timestamp--
						clientMsg = h
					}, false,
				},
				{
					"signature uses wrong sequence",
					func() {
						sm.Sequence++
						clientMsg = sm.CreateHeader(sm.Diversifier)
					},
					false,
				},
				{
					"signature uses new pubkey to sign",
					func() {
						// store in temp before assinging to interface type
						cs := sm.ClientState()
						h := sm.CreateHeader(sm.Diversifier)

						publicKey, err := codectypes.NewAnyWithValue(sm.PublicKey)
						suite.NoError(err)

						data := &solomachine.HeaderData{
							NewPubKey:      publicKey,
							NewDiversifier: h.NewDiversifier,
						}

						dataBz, err := suite.chainA.Codec.Marshal(data)
						suite.Require().NoError(err)

						// generate invalid signature
						signBytes := &solomachine.SignBytes{
							Sequence:    cs.Sequence,
							Timestamp:   sm.Time,
							Diversifier: sm.Diversifier,
							Path:        []byte("invalid signature data"),
							Data:        dataBz,
						}

						signBz, err := suite.chainA.Codec.Marshal(signBytes)
						suite.Require().NoError(err)

						sig := sm.GenerateSignature(signBz)
						suite.Require().NoError(err)
						h.Signature = sig

						clientState = cs
						clientMsg = h
					},
					false,
				},
				{
					"signature signs over old pubkey",
					func() {
						// store in temp before assinging to interface type
						cs := sm.ClientState()
						oldPubKey := sm.PublicKey
						h := sm.CreateHeader(sm.Diversifier)

						// generate invalid signature
						data := append(sdk.Uint64ToBigEndian(cs.Sequence), oldPubKey.Bytes()...)
						sig := sm.GenerateSignature(data)
						h.Signature = sig

						clientState = cs
						clientMsg = h
					},
					false,
				},
				{
					"consensus state public key is nil - header",
					func() {
						clientState.ConsensusState.PublicKey = nil
						clientMsg = sm.CreateHeader(sm.Diversifier)
					},
					false,
				},
			*/
		}

		for _, tc := range testCases {
			tc := tc

			suite.Run(tc.name, func() {
				clientState = &suite.clientState // wm.ClientState()

				// setup test
				tc.setup()

				err := clientState.VerifyClientMessage(suite.chainA.GetContext(), suite.chainA.Codec, suite.store, clientMsg)

				if tc.expPass {
					suite.Require().NoError(err)
				} else {
					suite.Require().Error(err)
				}
			})
		}
	}
}

func (suite *WasmTestSuite) TestWasm() {
	suite.Run("Init contract", func() {
		suite.SetupTest()
	})
}

func TestWasmTestSuite(t *testing.T) {
	suite.Run(t, new(WasmTestSuite))
}
